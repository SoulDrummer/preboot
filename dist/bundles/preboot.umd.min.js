!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/core"),require("@angular/common")):"function"==typeof define&&define.amd?define(["exports","@angular/core","@angular/common"],t):t(e.preboot=e.preboot||{},e.ng.core,e.ng.common)}(this,function(e,n,d){"use strict";function m(e){for(var t=[],n=e.root,r=e.node,o=r;o&&o!==n.serverNode&&o!==n.clientNode;)t.push(o),o=o.parentNode;o&&t.push(o);for(var i=r.nodeName||"unknown",s=t.length-1;0<=s;s--)if((o=t[s]).childNodes&&0<s)for(var c=0;c<o.childNodes.length;c++)if(o.childNodes[c]===t[s-1]){i+="_s"+(c+1);break}return i}var t=new n.InjectionToken("PrebootNonce");function g(e,t){void 0===t&&(t={});var n=e.tagName;if(t.tagName=n,t.eq=t.eq||[],e instanceof HTMLElement||e instanceof SVGSVGElement||e instanceof SVGPathElement||e instanceof SVGGElement)if(e.id){for(var r=(s=document.querySelectorAll(n+"#"+e.id)).length,o=0;o<r;o++)if(s.item(o)===e){t.id=e.id,t.eq.push(o);break}}else if(0<e.classList.length&&e instanceof HTMLElement){var i=function e(t,n,r){var o={};if(0<n.length){var i=n.join("."),s=document.querySelectorAll(t+"."+i);if(1===s.length&&1<n.length)return n.pop(),i=n.join("."),e(t,n,r);for(var c=s.length,a=0;a<c;a++)if(s.item(a)===r){o.eq=a,o.className=n.join(" ");break}}return o}(n,Array.from(e.classList),e);t.className=i.className||"",t.eq.push(i.eq||0)}else if(e.parentNode&&e.parentNode instanceof HTMLElement||e.parentNode instanceof SVGSVGElement||e.parentNode instanceof SVGPathElement||e.parentNode instanceof SVGGElement){var s;for(r=(s=e.parentNode.childNodes).length,o=0;o<r;o++)if(s.item(o)===e){t.eq.push(o);break}g(e.parentNode,t)}return t}function r(){return{prebootData:window.prebootData,getComputedStyle:window.getComputedStyle,document:document}}var o=function(){function e(){this.clientNodeCache={},this.replayStarted=!1}return e.prototype.setWindow=function(e){this.win=e},e.prototype.getWindow=function(){return this.win||(this.win=r()),this.win},e.prototype.replayAll=function(){var t=this;if(!this.replayStarted){this.replayStarted=!0;var e=this.getWindow().prebootData||{};(e.apps||[]).forEach(function(e){return t.replayForApp(e)}),this.cleanup(e)}},e.prototype.replayForApp=function(s){var c=this;s=s||{};try{var e=s.events||[];return new Promise(function(n){var r=e.slice(0),o=0,i=function(e,t){setTimeout(function(){return o+=1,c.replayEvent(s,e),r[o]?i(r[o],r[o].interval||0):(s.events.length=0,n())},t)};0<r.length&&i(r[o],r[o].interval||0)})}catch(e){console.error(e)}this.switchBuffer(s)},e.prototype.replayEvent=function(e,t){e=e||{};var n=(t=t||{}).event,r=t.node||{},o=t.nodeKey,i=t.nodePath,s=this.findClientNode({root:e.root,node:r,nodeKey:o,nodePath:i});if(s){s.checked=r.checked,s.selected=r.selected;var c=function(){s instanceof HTMLTextAreaElement||s instanceof HTMLInputElement?s.value=t.value:s.innerText=t.value};"keydown"===n.type&&c(),s.dispatchEvent(n),"keyup"===n.type&&c()}else console.warn("Trying to dispatch event "+n.type+" to node "+o+"\n        but could not find client node. Server node is: "+r)},e.prototype.switchBuffer=function(e){var t=(e=e||{}).root||{},n=t.serverNode,r=t.clientNode;if(r&&n&&n!==r&&"BODY"!==n.nodeName)try{var o=(0,this.getWindow().getComputedStyle)(n).getPropertyValue("display")||"block";n.remove?n.remove():n.style.display="none",r.style.display=o}catch(e){console.error(e)}},e.prototype.cleanup=function(e){var t=this,n=(e=e||{}).listeners||[],r=e.activeNode;null!=r&&setTimeout(function(){return t.setFocus(r)},1);for(var o=0,i=n;o<i.length;o++){var s=i[o];s.node.removeEventListener(s.eventName,s.handler)}var c=this.getWindow().document,a=c.getElementById("prebootOverlay");if(a&&(a.remove?a.remove():null!==a.parentNode?a.parentNode.removeChild(a):a.style.display="none"),e.apps=[],this.clientNodeCache={},"function"==typeof CustomEvent){var u=new CustomEvent("PrebootComplete");c.dispatchEvent(u)}else console.warn("Could not dispatch PrebootComplete event.\n       You can fix this by including a polyfill for CustomEvent.")},e.prototype.setFocus=function(e){if(e&&e.node&&e.nodeKey){var t=this.findClientNode(e);if(t&&t instanceof HTMLElement){t.focus();var n=e.selection;if(t.setSelectionRange&&n)try{t.setSelectionRange(n.start,n.end,n.direction)}catch(e){}}}},e.prototype.findClientNode=function(e){var t=(e=e||{}).root,n=e.nodePath;if(!t||!t.serverNode||!t.clientNode)return null;var r=e.nodeKey||m(e);if(this.clientNodeCache[r])return this.clientNodeCache[r];if(t.clientNode instanceof HTMLElement&&n){var o=n.tagName||"",i=n.eq,s=void 0;if(n.id)s=document.body.querySelectorAll(o+"#"+n.id);else if(n.className){var c=n.className.split(" ").join(".");s=document.body.querySelectorAll(o+"."+c)}else s=document.body.childNodes;var a=function(e,t){for(var n=t.pop(),r=e.item(n);r&&void 0!==n;){n=t.pop();var o=r.childNodes.item(n);if(!(o&&o instanceof HTMLElement||o instanceof SVGSVGElement||o instanceof SVGPathElement||o instanceof SVGGElement))return r;r=o}return r}(s,i);return null===a&&console.warn("can't find "+r+" element"),a}return null},e}();function i(e,t){var n=t||window,r=n.prebootData={opts:e,apps:[],listeners:[]};return function(){return s(r,n)}}function s(t,e){var n=(e||window).document||{},r=n.currentScript||[].slice.call(n.getElementsByTagName("script"),-1)[0];if(r){var o=r.parentNode;if(o){var i=(t.opts||{}).eventSelectors||[],s={root:t.opts?a(n,t.opts,o):null,events:[]};t.apps&&t.apps.push(s),(i=i.map(function(e){return e.hasOwnProperty("replay")||(e.replay=!0),e})).forEach(function(e){return u(n,t,s,e)})}else console.error("Preboot initialization failed, the script is detached")}else console.error("Preboot initialization failed, no currentScript has been detected.")}function c(e){var t=e.createElement("div");return t.setAttribute("id","prebootOverlay"),t.setAttribute("style","display:none;position:absolute;left:0;top:0;width:100%;height:100%;z-index:999999;background:black;opacity:.3"),e.documentElement.appendChild(t),t}function a(e,t,n){var r={serverNode:n};return r.clientNode=t.buffer?p(r):r.serverNode,r.overlay=c(e),r}function u(n,r,o,i){var s=o.root.serverNode;s&&i.events.forEach(function(e){var t=l(n,r,i,o);s.addEventListener(e,t,!0),r.listeners&&r.listeners.push({node:s,eventName:e,handler:t})})}function l(e,f,h,d){var y=["keyup","keydown","focusin","mouseup","mousedown"],v=["INPUT","TEXTAREA"],b=e.documentElement.matches||e.documentElement.msMatchesSelector;return function(t){var e=t.target;if(b.call(e,h.selector)){var n=d.root,r=t.type;if(e&&r){var o=h.keyCodes;if(o&&o.length)if(!o.filter(function(e){return t.which===e}).length)return;h.preventDefault&&t.preventDefault(),h.action&&h.action(e,t);var i=m({root:n,node:e}),s=g(e);if(0<=y.indexOf(r)&&0<=v.indexOf(e.tagName?e.tagName:"")?f.activeNode={root:n,node:e,nodeKey:i,nodePath:s,selection:E(e)}:"change"!==r&&"focusout"!==r&&(f.activeNode=void 0),h.freeze){var c=n.overlay;c.style.display="block",setTimeout(function(){c.style.display="none"},1e4)}if(h.replay){var a=d.events,u=function(e){var t=e.event;t.target instanceof HTMLTextAreaElement||t.target instanceof HTMLInputElement?e.value=t.target.value:e.value=t.target.innerText},l=0<a.length&&a[a.length-1];l&&"keyup"===l.event.type&&u(l);var p={node:e,nodeKey:i,event:t,nodePath:s,name:r};a.push(p),"keydown"===r&&u(p)}}}}}function E(e){var t=(e=e||{}).value||"",n={start:t.length,end:t.length,direction:"forward"};try{(e.selectionStart||0===e.selectionStart)&&(n.start=e.selectionStart,n.end=e.selectionEnd?e.selectionEnd:0,n.direction=e.selectionDirection?e.selectionDirection:"none")}catch(e){}return n}function p(e){var t=e.serverNode;if(!t||!t.parentNode||t===document.documentElement||t===document.body)return t;var n=t.cloneNode(!1);return n.style.display="none",t.parentNode.insertBefore(n,t),t.setAttribute("ng-non-bindable",""),n}var f={start:s,createOverlay:c,getAppRoot:a,handleEvents:u,createListenHandler:l,getSelection:E,createBuffer:p},h="prebootInitFn",y={buffer:!0,replay:!0,eventSelectors:[{selector:"input,textarea",events:["keypress","keyup","keydown","input","change"]},{selector:"select,option",events:["change"]},{selector:"input",events:["keyup"],preventDefault:!0,keyCodes:[13],freeze:!0},{selector:"form",events:["submit"],preventDefault:!0,freeze:!0},{selector:"input,textarea",events:["focusin","focusout","mousedown","mouseup"],replay:!1},{selector:"button",events:["click"],preventDefault:!0,freeze:!0}]};function v(){var e=[];for(var t in f)if(f.hasOwnProperty(t)){var n=f[t].toString().replace("common_1.","");e.push(n)}return e.push(m.toString()),"\n\n"+e.join("\n\n")+"\n\n"}function b(e){var t=S({},y,e);_(t);var n=v(),r=N(t),o=i.toString();return"var "+h+" = (function() {\n      "+n+"\n      return ("+o.replace("common_1.","")+")("+r+");\n    })();"}function w(){return h+"();"}function _(e){if(!e.appRoot||!e.appRoot.length)throw new Error("The appRoot is missing from preboot options. This is needed to find the root of your application. Set this value in the preboot options to be a selector for the root element of your app.")}function S(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];if(null==e)throw new TypeError("Cannot convert undefined or null to object");for(var r=Object(e),o=0;o<t.length;o++){var i=t[o];if(null!=i)for(var s in i)i.hasOwnProperty&&i.hasOwnProperty(s)&&(r[s]=i[s])}return r}function N(e){for(var t,n,r="START_FUNCTION_HERE",o="STOP_FUNCTION_HERE",i=JSON.stringify(e,function(e,t){return t&&t.constructor&&t.call&&t.apply?r+t.toString()+o:t}),s=i.indexOf(r);0<=s;)t=i.indexOf(o),n=(n=i.substring(s+r.length,t)).replace(/\\n/g,"\n"),s=(i=i.substring(0,s-1)+n+i.substring(t+o.length+1)).indexOf(r);return i}var T=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};function O(e,t){function n(){this.constructor=e}T(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}var P,x={e:{}};function A(){try{return P.apply(this,arguments)}catch(e){return x.e=e,x}}function k(e){return P=e,A}function C(e){return"function"==typeof e}var D=!1,H={Promise:void 0,set useDeprecatedSynchronousErrorHandling(e){e&&(new Error).stack;D=e},get useDeprecatedSynchronousErrorHandling(){return D}};function R(e){setTimeout(function(){throw e})}var j={closed:!0,next:function(e){},error:function(e){if(H.useDeprecatedSynchronousErrorHandling)throw e;R(e)},complete:function(){}},M=Array.isArray||function(e){return e&&"number"==typeof e.length};function V(e){return null!=e&&"object"==typeof e}var L=function(n){function r(e){var t=n.call(this,e?e.length+" errors occurred during unsubscription:\n  "+e.map(function(e,t){return t+1+") "+e.toString()}).join("\n  "):"")||this;return t.errors=e,t.name="UnsubscriptionError",Object.setPrototypeOf(t,r.prototype),t}return O(r,n),r}(Error),q=function(){function r(e){this.closed=!1,this._parent=null,this._parents=null,this._subscriptions=null,e&&(this._unsubscribe=e)}var e;return r.prototype.unsubscribe=function(){var e,t=!1;if(!this.closed){var n=this._parent,r=this._parents,o=this._unsubscribe,i=this._subscriptions;this.closed=!0,this._parent=null,this._parents=null,this._subscriptions=null;for(var s=-1,c=r?r.length:0;n;)n.remove(this),n=++s<c&&r[s]||null;if(C(o))k(o).call(this)===x&&(t=!0,e=e||(x.e instanceof L?G(x.e.errors):[x.e]));if(M(i))for(s=-1,c=i.length;++s<c;){var a=i[s];if(V(a))if(k(a.unsubscribe).call(a)===x){t=!0,e=e||[];var u=x.e;u instanceof L?e=e.concat(G(u.errors)):e.push(u)}}if(t)throw new L(e)}},r.prototype.add=function(e){if(!e||e===r.EMPTY)return r.EMPTY;if(e===this)return this;var t=e;switch(typeof e){case"function":t=new r(e);case"object":if(t.closed||"function"!=typeof t.unsubscribe)return t;if(this.closed)return t.unsubscribe(),t;if("function"!=typeof t._addParent){var n=t;(t=new r)._subscriptions=[n]}break;default:throw new Error("unrecognized teardown "+e+" added to Subscription.")}return(this._subscriptions||(this._subscriptions=[])).push(t),t._addParent(this),t},r.prototype.remove=function(e){var t=this._subscriptions;if(t){var n=t.indexOf(e);-1!==n&&t.splice(n,1)}},r.prototype._addParent=function(e){var t=this._parent,n=this._parents;t&&t!==e?n?-1===n.indexOf(e)&&n.push(e):this._parents=[e]:this._parent=e},r.EMPTY=((e=new r).closed=!0,e),r}();function G(e){return e.reduce(function(e,t){return e.concat(t instanceof L?t.errors:t)},[])}var I="function"==typeof Symbol&&"function"==typeof Symbol.for?Symbol.for("rxSubscriber"):"@@rxSubscriber",B=function(s){function o(e,t,n){var r,o=s.call(this)||this;switch(o.syncErrorValue=null,o.syncErrorThrown=!1,o.syncErrorThrowable=!1,o.isStopped=!1,arguments.length){case 0:o.destination=j;break;case 1:if(!e){o.destination=j;break}if("object"==typeof e){if((r=e)instanceof B||"syncErrorThrowable"in r&&r[I]){var i=e[I]();o.syncErrorThrowable=i.syncErrorThrowable,(o.destination=i).add(o)}else o.syncErrorThrowable=!0,o.destination=new F(o,e);break}default:o.syncErrorThrowable=!0,o.destination=new F(o,e,t,n)}return o}return O(o,s),o.prototype[I]=function(){return this},o.create=function(e,t,n){var r=new o(e,t,n);return r.syncErrorThrowable=!1,r},o.prototype.next=function(e){this.isStopped||this._next(e)},o.prototype.error=function(e){this.isStopped||(this.isStopped=!0,this._error(e))},o.prototype.complete=function(){this.isStopped||(this.isStopped=!0,this._complete())},o.prototype.unsubscribe=function(){this.closed||(this.isStopped=!0,s.prototype.unsubscribe.call(this))},o.prototype._next=function(e){this.destination.next(e)},o.prototype._error=function(e){this.destination.error(e),this.unsubscribe()},o.prototype._complete=function(){this.destination.complete(),this.unsubscribe()},o.prototype._unsubscribeAndRecycle=function(){var e=this._parent,t=this._parents;return this._parent=null,this._parents=null,this.unsubscribe(),this.closed=!1,this.isStopped=!1,this._parent=e,this._parents=t,this},o}(q),F=function(c){function e(e,t,n,r){var o,i=c.call(this)||this;i._parentSubscriber=e;var s=i;return C(t)?o=t:t&&(o=t.next,n=t.error,r=t.complete,t!==j&&(C((s=Object.create(t)).unsubscribe)&&i.add(s.unsubscribe.bind(s)),s.unsubscribe=i.unsubscribe.bind(i))),i._context=s,i._next=o,i._error=n,i._complete=r,i}return O(e,c),e.prototype.next=function(e){if(!this.isStopped&&this._next){var t=this._parentSubscriber;H.useDeprecatedSynchronousErrorHandling&&t.syncErrorThrowable?this.__tryOrSetError(t,this._next,e)&&this.unsubscribe():this.__tryOrUnsub(this._next,e)}},e.prototype.error=function(e){if(!this.isStopped){var t=this._parentSubscriber,n=H.useDeprecatedSynchronousErrorHandling;if(this._error)n&&t.syncErrorThrowable?this.__tryOrSetError(t,this._error,e):this.__tryOrUnsub(this._error,e),this.unsubscribe();else if(t.syncErrorThrowable)n?(t.syncErrorValue=e,t.syncErrorThrown=!0):R(e),this.unsubscribe();else{if(this.unsubscribe(),n)throw e;R(e)}}},e.prototype.complete=function(){var e=this;if(!this.isStopped){var t=this._parentSubscriber;if(this._complete){var n=function(){return e._complete.call(e._context)};H.useDeprecatedSynchronousErrorHandling&&t.syncErrorThrowable?this.__tryOrSetError(t,n):this.__tryOrUnsub(n),this.unsubscribe()}else this.unsubscribe()}},e.prototype.__tryOrUnsub=function(e,t){try{e.call(this._context,t)}catch(e){if(this.unsubscribe(),H.useDeprecatedSynchronousErrorHandling)throw e;R(e)}},e.prototype.__tryOrSetError=function(t,e,n){if(!H.useDeprecatedSynchronousErrorHandling)throw new Error("bad call");try{e.call(this._context,n)}catch(e){return H.useDeprecatedSynchronousErrorHandling?(t.syncErrorValue=e,t.syncErrorThrown=!0):(R(e),!0)}return!1},e.prototype._unsubscribe=function(){var e=this._parentSubscriber;this._context=null,this._parentSubscriber=null,e.unsubscribe()},e}(B);var U="function"==typeof Symbol&&Symbol.observable||"@@observable";function z(){}var K=function(){function n(e){this._isScalar=!1,e&&(this._subscribe=e)}return n.prototype.lift=function(e){var t=new n;return t.source=this,t.operator=e,t},n.prototype.subscribe=function(e,t,n){var r=this.operator,o=function(e,t,n){if(e){if(e instanceof B)return e;if(e[I])return e[I]()}return e||t||n?new B(e,t,n):new B(j)}(e,t,n);if(r?r.call(o,this.source):o.add(this.source||!o.syncErrorThrowable?this._subscribe(o):this._trySubscribe(o)),H.useDeprecatedSynchronousErrorHandling&&o.syncErrorThrowable&&(o.syncErrorThrowable=!1,o.syncErrorThrown))throw o.syncErrorValue;return o},n.prototype._trySubscribe=function(t){try{return this._subscribe(t)}catch(e){H.useDeprecatedSynchronousErrorHandling&&(t.syncErrorThrown=!0,t.syncErrorValue=e),t.error(e)}},n.prototype.forEach=function(r,e){var o=this;return new(e=W(e))(function(e,t){var n;n=o.subscribe(function(e){try{r(e)}catch(e){t(e),n&&n.unsubscribe()}},t,e)})},n.prototype._subscribe=function(e){var t=this.source;return t&&t.subscribe(e)},n.prototype[U]=function(){return this},n.prototype.pipe=function(){for(var t,e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];return 0===e.length?this:((t=e)?1===t.length?t[0]:function(e){return t.reduce(function(e,t){return t(e)},e)}:z)(this)},n.prototype.toPromise=function(e){var r=this;return new(e=W(e))(function(e,t){var n;r.subscribe(function(e){return n=e},function(e){return t(e)},function(){return e(n)})})},n.create=function(e){return new n(e)},n}();function W(e){if(e||(e=H.Promise||Promise),!e)throw new Error("no Promise impl found");return e}var Y=new K(function(e){return e.complete()});function J(e){return e?(t=e,new K(function(e){return t.schedule(function(){return e.complete()})})):Y;var t}var X=function(t){function n(){var e=t.call(this,"argument out of range")||this;return e.name="ArgumentOutOfRangeError",Object.setPrototypeOf(e,n.prototype),e}return O(n,t),n}(Error);var Q=function(){function e(e,t){this.predicate=e,this.thisArg=t}return e.prototype.call=function(e,t){return t.subscribe(new Z(e,this.predicate,this.thisArg))},e}(),Z=function(o){function e(e,t,n){var r=o.call(this,e)||this;return r.predicate=t,r.thisArg=n,r.count=0,r}return O(e,o),e.prototype._next=function(e){var t;try{t=this.predicate.call(this.thisArg,e,this.count++)}catch(e){return void this.destination.error(e)}t&&this.destination.next(e)},e}(B);Error;var $=function(){function e(e){if(this.total=e,this.total<0)throw new X}return e.prototype.call=function(e,t){return t.subscribe(new ee(e,this.total))},e}(),ee=function(r){function e(e,t){var n=r.call(this,e)||this;return n.total=t,n.count=0,n}return O(e,r),e.prototype._next=function(e){var t=this.total,n=++this.count;n<=t&&(this.destination.next(e),n===t&&(this.destination.complete(),this.unsubscribe()))},e}(B);Error;Error;var te="preboot-inline-script",ne=new n.InjectionToken("PrebootOptions");function re(e,t,n){var r=e.createElement("script");return t&&(r.nonce=t),r.className=te,r.textContent=n,r}function oe(a,u,l,p,f,h){return function(){if(_(u),d.isPlatformServer(p)){var e=b(u),t=re(a,l,e),o=w(),n=a.getElementsByClassName(te);if(0===n.length){var r=[].concat(u.appRoot);a.head.appendChild(t),r.map(function(e){return{selector:e,appRootElem:a.querySelector(e)}}).forEach(function(e){var t=e.selector,n=e.appRootElem;if(n){var r=re(a,l,o);n.insertBefore(r,n.firstChild)}else console.log("No server node found for selector: "+t)})}else 0<n.length&&l&&(n[0].nonce=l)}var i,s,c;d.isPlatformBrowser(p)&&((null==u.replay||u.replay)&&f.isStable.pipe((s=function(e){return e},function(e){return e.lift(new Q(s,c))}),(i=1,function(e){return 0===i?J():e.lift(new $(i))})).subscribe(function(){h.replayAll()}))}}var ie={provide:n.APP_BOOTSTRAP_LISTENER,useFactory:oe,deps:[d.DOCUMENT,ne,[new n.Optional,new n.Inject(t)],n.PLATFORM_ID,n.ApplicationRef,o],multi:!0},se=function(){function t(){}return t.withConfig=function(e){return{ngModule:t,providers:[{provide:ne,useValue:e}]}},t.decorators=[{type:n.NgModule,args:[{providers:[o,ie]}]}],t}();e.getNodeKeyForPreboot=m,e.PREBOOT_NONCE=t,e._window=r,e.EventReplayer=o,e.initAll=i,e.start=s,e.createOverlay=c,e.getAppRoot=a,e.handleEvents=u,e.createListenHandler=l,e.getSelection=E,e.createBuffer=p,e.initFunctionName=h,e.defaultOptions=y,e.getEventRecorderCode=v,e.getInlineDefinition=b,e.getInlineInvocation=w,e.validateOptions=_,e.assign=S,e.stringifyWithFunctions=N,e.PrebootModule=se,e.ɵb=oe,e.ɵa=ne,e.ɵc=ie,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=preboot.umd.min.js.map
