!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/core"),require("@angular/common")):"function"==typeof define&&define.amd?define(["exports","@angular/core","@angular/common"],t):t(e.preboot=e.preboot||{},e.ng.core,e.ng.common)}(this,function(e,r,d){"use strict";function b(e){for(var t=[],r=e.root,n=e.node,o=n;o&&o!==r.serverNode&&o!==r.clientNode;)t.push(o),o=o.parentNode;o&&t.push(o);for(var i=n.nodeName||"unknown",s=t.length-1;0<=s;s--)if((o=t[s]).childNodes&&0<s)for(var c=0;c<o.childNodes.length;c++)if(o.childNodes[c]===t[s-1]){i+="_s"+(c+1);break}return i}var t=new r.InjectionToken("PrebootNonce");function n(){return{prebootData:window.prebootData,getComputedStyle:window.getComputedStyle,document:document}}var o=function(){function e(){this.clientNodeCache={},this.replayStarted=!1}return e.prototype.setWindow=function(e){this.win=e},e.prototype.getWindow=function(){return this.win||(this.win=n()),this.win},e.prototype.replayAll=function(){var t=this;if(!this.replayStarted){this.replayStarted=!0;var e=this.getWindow().prebootData||{};(e.apps||[]).forEach(function(e){return t.replayForApp(e)}),this.cleanup(e)}},e.prototype.replayForApp=function(s){var c=this;s=s||{};try{var e=s.events||[];return new Promise(function(r){var n=e.slice(0),o=0,i=function(e,t){setTimeout(function(){return o+=1,c.replayEvent(s,e),n[o]?i(n[o],n[o].interval||0):(s.events.length=0,r())},t)};0<n.length&&i(n[o],n[o].interval||0)})}catch(e){console.error(e)}this.switchBuffer(s)},e.prototype.replayEvent=function(e,t){e=e||{};var r=(t=t||{}).event,n=t.node||{},o=t.nodeKey,i=this.findClientNode({root:e.root,node:n,nodeKey:o});if(i){i.checked=n.checked,i.selected=n.selected;var s=function(){i instanceof HTMLTextAreaElement||i instanceof HTMLInputElement?i.value=t.value:i.innerText=t.value};"keydown"===r.type&&s(),i.dispatchEvent(r),"keyup"===r.type&&s()}else console.warn("Trying to dispatch event "+r.type+" to node "+o+"\n        but could not find client node. Server node is: "+n)},e.prototype.switchBuffer=function(e){var t=(e=e||{}).root||{},r=t.serverNode,n=t.clientNode;if(n&&r&&r!==n&&"BODY"!==r.nodeName)try{var o=(0,this.getWindow().getComputedStyle)(r).getPropertyValue("display")||"block";r.remove?r.remove():r.style.display="none",n.style.display=o}catch(e){console.error(e)}},e.prototype.cleanup=function(e){var t=this,r=(e=e||{}).listeners||[],n=e.activeNode;null!=n&&setTimeout(function(){return t.setFocus(n)},1);for(var o=0,i=r;o<i.length;o++){var s=i[o];s.node.removeEventListener(s.eventName,s.handler)}var c=this.getWindow().document,u=c.getElementById("prebootOverlay");if(u&&(u.remove?u.remove():null!==u.parentNode?u.parentNode.removeChild(u):u.style.display="none"),e.apps=[],this.clientNodeCache={},"function"==typeof CustomEvent){var a=new CustomEvent("PrebootComplete");c.dispatchEvent(a)}else console.warn("Could not dispatch PrebootComplete event.\n       You can fix this by including a polyfill for CustomEvent.")},e.prototype.setFocus=function(e){if(e&&e.node&&e.nodeKey){var t=this.findClientNode(e);if(t){t.focus();var r=e.selection;if(t.setSelectionRange&&r)try{t.setSelectionRange(r.start,r.end,r.direction)}catch(e){}}}},e.prototype.findClientNode=function(e){var t=(e=e||{}).node,r=e.root;if(!r||!r.serverNode||!r.clientNode)return null;var n=e.nodeKey||b(e);if(this.clientNodeCache[n])return this.clientNodeCache[n];var o=(t.className||"").replace("ng-binding","").trim(),i=t.tagName;t.id?i+="#"+t.id:o&&(i+="."+o.replace(/ /g,"."));var s=r.clientNode,c=s.querySelectorAll(i);c.length||(console.log("nothing found for "+i+" so using "+t.tagName),c=s.querySelectorAll(t.tagName));for(var u=c.length,a=0;a<u;a++){var l=c.item(a);if(b({root:r,node:l})===n)return this.clientNodeCache[n]=l}return 1===c.length?(this.clientNodeCache[n]=c[0],c[0]):(console.warn("No matching client node found for "+n+".\n       You can fix this by assigning this element a unique id attribute."),null)},e}();function i(e,t){var r=t||window,n=r.prebootData={opts:e,apps:[],listeners:[]};return function(){return s(n,r)}}function s(t,e){var r=(e||window).document||{},n=r.currentScript||[].slice.call(r.getElementsByTagName("script"),-1)[0];if(n){var o=n.parentNode;if(o){var i=(t.opts||{}).eventSelectors||[],s={root:t.opts?u(r,t.opts,o):null,events:[]};t.apps&&t.apps.push(s),(i=i.map(function(e){return e.hasOwnProperty("replay")||(e.replay=!0),e})).forEach(function(e){return a(r,t,s,e)})}else console.error("Preboot initialization failed, the script is detached")}else console.error("Preboot initialization failed, no currentScript has been detected.")}function c(e){var t=e.createElement("div");return t.setAttribute("id","prebootOverlay"),t.setAttribute("style","display:none;position:absolute;left:0;top:0;width:100%;height:100%;z-index:999999;background:black;opacity:.3"),e.documentElement.appendChild(t),t}function u(e,t,r){var n={serverNode:r};return n.clientNode=t.buffer?p(n):n.serverNode,n.overlay=c(e),n}function a(r,n,o,i){var s=o.root.serverNode;s&&i.events.forEach(function(e){var t=l(r,n,i,o);s.addEventListener(e,t,!0),n.listeners&&n.listeners.push({node:s,eventName:e,handler:t})})}function l(e,p,f,h){var d=["keyup","keydown","focusin","mouseup","mousedown"],y=["INPUT","TEXTAREA"],v=e.documentElement.matches||e.documentElement.msMatchesSelector;return function(t){var e=t.target;if(v.call(e,f.selector)){var r=h.root,n=t.type;if(e&&n){var o=f.keyCodes;if(o&&o.length)if(!o.filter(function(e){return t.which===e}).length)return;f.preventDefault&&t.preventDefault(),f.action&&f.action(e,t);var i=b({root:r,node:e});if(0<=d.indexOf(n)&&0<=y.indexOf(e.tagName?e.tagName:"")?p.activeNode={root:r,node:e,nodeKey:i,selection:g(e)}:"change"!==n&&"focusout"!==n&&(p.activeNode=void 0),f.freeze){var s=r.overlay;s.style.display="block",setTimeout(function(){s.style.display="none"},1e4)}if(f.replay){var c=h.events,u=function(e){var t=e.event;t.target instanceof HTMLTextAreaElement||t.target instanceof HTMLInputElement?e.value=t.target.value:e.value=t.target.innerText},a=0<c.length&&c[c.length-1];a&&"keyup"===a.event.type&&u(a);var l={node:e,nodeKey:i,event:t,name:n};c.push(l),"keydown"===n&&u(l)}}}}}function g(e){var t=(e=e||{}).value||"",r={start:t.length,end:t.length,direction:"forward"};try{(e.selectionStart||0===e.selectionStart)&&(r.start=e.selectionStart,r.end=e.selectionEnd?e.selectionEnd:0,r.direction=e.selectionDirection?e.selectionDirection:"none")}catch(e){}return r}function p(e){var t=e.serverNode;if(!t||!t.parentNode||t===document.documentElement||t===document.body)return t;var r=t.cloneNode(!1);return r.style.display="none",t.parentNode.insertBefore(r,t),t.setAttribute("ng-non-bindable",""),r}var f={start:s,createOverlay:c,getAppRoot:u,handleEvents:a,createListenHandler:l,getSelection:g,createBuffer:p},h="prebootInitFn",y={buffer:!0,replay:!0,eventSelectors:[{selector:"input,textarea",events:["keypress","keyup","keydown","input","change"]},{selector:"select,option",events:["change"]},{selector:"input",events:["keyup"],preventDefault:!0,keyCodes:[13],freeze:!0},{selector:"form",events:["submit"],preventDefault:!0,freeze:!0},{selector:"input,textarea",events:["focusin","focusout","mousedown","mouseup"],replay:!1},{selector:"button",events:["click"],preventDefault:!0,freeze:!0}]};function v(){var e=[];for(var t in f)if(f.hasOwnProperty(t)){var r=f[t].toString().replace("common_1.","");e.push(r)}return e.push(b.toString()),"\n\n"+e.join("\n\n")+"\n\n"}function m(e){var t=E({},y,e);_(t);var r=v(),n=S(t),o=i.toString();return"var "+h+" = (function() {\n      "+r+"\n      return ("+o.replace("common_1.","")+")("+n+");\n    })();"}function w(){return h+"();"}function _(e){if(!e.appRoot||!e.appRoot.length)throw new Error("The appRoot is missing from preboot options. This is needed to find the root of your application. Set this value in the preboot options to be a selector for the root element of your app.")}function E(e){for(var t=[],r=1;r<arguments.length;r++)t[r-1]=arguments[r];if(null==e)throw new TypeError("Cannot convert undefined or null to object");for(var n=Object(e),o=0;o<t.length;o++){var i=t[o];if(null!=i)for(var s in i)i.hasOwnProperty&&i.hasOwnProperty(s)&&(n[s]=i[s])}return n}function S(e){for(var t,r,n="START_FUNCTION_HERE",o="STOP_FUNCTION_HERE",i=JSON.stringify(e,function(e,t){return t&&t.constructor&&t.call&&t.apply?n+t.toString()+o:t}),s=i.indexOf(n);0<=s;)t=i.indexOf(o),r=(r=i.substring(s+n.length,t)).replace(/\\n/g,"\n"),s=(i=i.substring(0,s-1)+r+i.substring(t+o.length+1)).indexOf(n);return i}var N=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};function T(e,t){function r(){this.constructor=e}N(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}var O,x={e:{}};function P(){try{return O.apply(this,arguments)}catch(e){return x.e=e,x}}function C(e){return O=e,P}function A(e){return"function"==typeof e}var k=!1,D={Promise:void 0,set useDeprecatedSynchronousErrorHandling(e){e&&(new Error).stack;k=e},get useDeprecatedSynchronousErrorHandling(){return k}};function R(e){setTimeout(function(){throw e})}var H={closed:!0,next:function(e){},error:function(e){if(D.useDeprecatedSynchronousErrorHandling)throw e;R(e)},complete:function(){}},j=Array.isArray||function(e){return e&&"number"==typeof e.length};function I(e){return null!=e&&"object"==typeof e}var M=function(r){function n(e){var t=r.call(this,e?e.length+" errors occurred during unsubscription:\n  "+e.map(function(e,t){return t+1+") "+e.toString()}).join("\n  "):"")||this;return t.errors=e,t.name="UnsubscriptionError",Object.setPrototypeOf(t,n.prototype),t}return T(n,r),n}(Error),B=function(){function n(e){this.closed=!1,this._parent=null,this._parents=null,this._subscriptions=null,e&&(this._unsubscribe=e)}var e;return n.prototype.unsubscribe=function(){var e,t=!1;if(!this.closed){var r=this._parent,n=this._parents,o=this._unsubscribe,i=this._subscriptions;this.closed=!0,this._parent=null,this._parents=null,this._subscriptions=null;for(var s=-1,c=n?n.length:0;r;)r.remove(this),r=++s<c&&n[s]||null;if(A(o))C(o).call(this)===x&&(t=!0,e=e||(x.e instanceof M?F(x.e.errors):[x.e]));if(j(i))for(s=-1,c=i.length;++s<c;){var u=i[s];if(I(u))if(C(u.unsubscribe).call(u)===x){t=!0,e=e||[];var a=x.e;a instanceof M?e=e.concat(F(a.errors)):e.push(a)}}if(t)throw new M(e)}},n.prototype.add=function(e){if(!e||e===n.EMPTY)return n.EMPTY;if(e===this)return this;var t=e;switch(typeof e){case"function":t=new n(e);case"object":if(t.closed||"function"!=typeof t.unsubscribe)return t;if(this.closed)return t.unsubscribe(),t;if("function"!=typeof t._addParent){var r=t;(t=new n)._subscriptions=[r]}break;default:throw new Error("unrecognized teardown "+e+" added to Subscription.")}return(this._subscriptions||(this._subscriptions=[])).push(t),t._addParent(this),t},n.prototype.remove=function(e){var t=this._subscriptions;if(t){var r=t.indexOf(e);-1!==r&&t.splice(r,1)}},n.prototype._addParent=function(e){var t=this._parent,r=this._parents;t&&t!==e?r?-1===r.indexOf(e)&&r.push(e):this._parents=[e]:this._parent=e},n.EMPTY=((e=new n).closed=!0,e),n}();function F(e){return e.reduce(function(e,t){return e.concat(t instanceof M?t.errors:t)},[])}var L="function"==typeof Symbol&&"function"==typeof Symbol.for?Symbol.for("rxSubscriber"):"@@rxSubscriber",U=function(s){function o(e,t,r){var n,o=s.call(this)||this;switch(o.syncErrorValue=null,o.syncErrorThrown=!1,o.syncErrorThrowable=!1,o.isStopped=!1,arguments.length){case 0:o.destination=H;break;case 1:if(!e){o.destination=H;break}if("object"==typeof e){if((n=e)instanceof U||"syncErrorThrowable"in n&&n[L]){var i=e[L]();o.syncErrorThrowable=i.syncErrorThrowable,(o.destination=i).add(o)}else o.syncErrorThrowable=!0,o.destination=new z(o,e);break}default:o.syncErrorThrowable=!0,o.destination=new z(o,e,t,r)}return o}return T(o,s),o.prototype[L]=function(){return this},o.create=function(e,t,r){var n=new o(e,t,r);return n.syncErrorThrowable=!1,n},o.prototype.next=function(e){this.isStopped||this._next(e)},o.prototype.error=function(e){this.isStopped||(this.isStopped=!0,this._error(e))},o.prototype.complete=function(){this.isStopped||(this.isStopped=!0,this._complete())},o.prototype.unsubscribe=function(){this.closed||(this.isStopped=!0,s.prototype.unsubscribe.call(this))},o.prototype._next=function(e){this.destination.next(e)},o.prototype._error=function(e){this.destination.error(e),this.unsubscribe()},o.prototype._complete=function(){this.destination.complete(),this.unsubscribe()},o.prototype._unsubscribeAndRecycle=function(){var e=this._parent,t=this._parents;return this._parent=null,this._parents=null,this.unsubscribe(),this.closed=!1,this.isStopped=!1,this._parent=e,this._parents=t,this},o}(B),z=function(c){function e(e,t,r,n){var o,i=c.call(this)||this;i._parentSubscriber=e;var s=i;return A(t)?o=t:t&&(o=t.next,r=t.error,n=t.complete,t!==H&&(A((s=Object.create(t)).unsubscribe)&&i.add(s.unsubscribe.bind(s)),s.unsubscribe=i.unsubscribe.bind(i))),i._context=s,i._next=o,i._error=r,i._complete=n,i}return T(e,c),e.prototype.next=function(e){if(!this.isStopped&&this._next){var t=this._parentSubscriber;D.useDeprecatedSynchronousErrorHandling&&t.syncErrorThrowable?this.__tryOrSetError(t,this._next,e)&&this.unsubscribe():this.__tryOrUnsub(this._next,e)}},e.prototype.error=function(e){if(!this.isStopped){var t=this._parentSubscriber,r=D.useDeprecatedSynchronousErrorHandling;if(this._error)r&&t.syncErrorThrowable?this.__tryOrSetError(t,this._error,e):this.__tryOrUnsub(this._error,e),this.unsubscribe();else if(t.syncErrorThrowable)r?(t.syncErrorValue=e,t.syncErrorThrown=!0):R(e),this.unsubscribe();else{if(this.unsubscribe(),r)throw e;R(e)}}},e.prototype.complete=function(){var e=this;if(!this.isStopped){var t=this._parentSubscriber;if(this._complete){var r=function(){return e._complete.call(e._context)};D.useDeprecatedSynchronousErrorHandling&&t.syncErrorThrowable?this.__tryOrSetError(t,r):this.__tryOrUnsub(r),this.unsubscribe()}else this.unsubscribe()}},e.prototype.__tryOrUnsub=function(e,t){try{e.call(this._context,t)}catch(e){if(this.unsubscribe(),D.useDeprecatedSynchronousErrorHandling)throw e;R(e)}},e.prototype.__tryOrSetError=function(t,e,r){if(!D.useDeprecatedSynchronousErrorHandling)throw new Error("bad call");try{e.call(this._context,r)}catch(e){return D.useDeprecatedSynchronousErrorHandling?(t.syncErrorValue=e,t.syncErrorThrown=!0):(R(e),!0)}return!1},e.prototype._unsubscribe=function(){var e=this._parentSubscriber;this._context=null,this._parentSubscriber=null,e.unsubscribe()},e}(U);var K="function"==typeof Symbol&&Symbol.observable||"@@observable";function V(){}var q=function(){function r(e){this._isScalar=!1,e&&(this._subscribe=e)}return r.prototype.lift=function(e){var t=new r;return t.source=this,t.operator=e,t},r.prototype.subscribe=function(e,t,r){var n=this.operator,o=function(e,t,r){if(e){if(e instanceof U)return e;if(e[L])return e[L]()}return e||t||r?new U(e,t,r):new U(H)}(e,t,r);if(n?n.call(o,this.source):o.add(this.source||!o.syncErrorThrowable?this._subscribe(o):this._trySubscribe(o)),D.useDeprecatedSynchronousErrorHandling&&o.syncErrorThrowable&&(o.syncErrorThrowable=!1,o.syncErrorThrown))throw o.syncErrorValue;return o},r.prototype._trySubscribe=function(t){try{return this._subscribe(t)}catch(e){D.useDeprecatedSynchronousErrorHandling&&(t.syncErrorThrown=!0,t.syncErrorValue=e),t.error(e)}},r.prototype.forEach=function(n,e){var o=this;return new(e=W(e))(function(e,t){var r;r=o.subscribe(function(e){try{n(e)}catch(e){t(e),r&&r.unsubscribe()}},t,e)})},r.prototype._subscribe=function(e){var t=this.source;return t&&t.subscribe(e)},r.prototype[K]=function(){return this},r.prototype.pipe=function(){for(var t,e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];return 0===e.length?this:((t=e)?1===t.length?t[0]:function(e){return t.reduce(function(e,t){return t(e)},e)}:V)(this)},r.prototype.toPromise=function(e){var n=this;return new(e=W(e))(function(e,t){var r;n.subscribe(function(e){return r=e},function(e){return t(e)},function(){return e(r)})})},r.create=function(e){return new r(e)},r}();function W(e){if(e||(e=D.Promise||Promise),!e)throw new Error("no Promise impl found");return e}var Y=new q(function(e){return e.complete()});function J(e){return e?(t=e,new q(function(e){return t.schedule(function(){return e.complete()})})):Y;var t}var X=function(t){function r(){var e=t.call(this,"argument out of range")||this;return e.name="ArgumentOutOfRangeError",Object.setPrototypeOf(e,r.prototype),e}return T(r,t),r}(Error);var G=function(){function e(e,t){this.predicate=e,this.thisArg=t}return e.prototype.call=function(e,t){return t.subscribe(new Q(e,this.predicate,this.thisArg))},e}(),Q=function(o){function e(e,t,r){var n=o.call(this,e)||this;return n.predicate=t,n.thisArg=r,n.count=0,n}return T(e,o),e.prototype._next=function(e){var t;try{t=this.predicate.call(this.thisArg,e,this.count++)}catch(e){return void this.destination.error(e)}t&&this.destination.next(e)},e}(U);Error;var Z=function(){function e(e){if(this.total=e,this.total<0)throw new X}return e.prototype.call=function(e,t){return t.subscribe(new $(e,this.total))},e}(),$=function(n){function e(e,t){var r=n.call(this,e)||this;return r.total=t,r.count=0,r}return T(e,n),e.prototype._next=function(e){var t=this.total,r=++this.count;r<=t&&(this.destination.next(e),r===t&&(this.destination.complete(),this.unsubscribe()))},e}(U);Error;Error;var ee="preboot-inline-script",te=new r.InjectionToken("PrebootOptions");function re(e,t,r){var n=e.createElement("script");return t&&(n.nonce=t),n.className=ee,n.textContent=r,n}function ne(u,a,l,p,f,h){return function(){if(_(a),d.isPlatformServer(p)){var e=m(a),t=re(u,l,e),o=w(),r=u.getElementsByClassName(ee);if(0===r.length){var n=[].concat(a.appRoot);u.head.appendChild(t),n.map(function(e){return{selector:e,appRootElem:u.querySelector(e)}}).forEach(function(e){var t=e.selector,r=e.appRootElem;if(r){var n=re(u,l,o);r.insertBefore(n,r.firstChild)}else console.log("No server node found for selector: "+t)})}else 0<r.length&&l&&(r[0].nonce=l)}var i,s,c;d.isPlatformBrowser(p)&&((null==a.replay||a.replay)&&f.isStable.pipe((s=function(e){return e},function(e){return e.lift(new G(s,c))}),(i=1,function(e){return 0===i?J():e.lift(new Z(i))})).subscribe(function(){h.replayAll()}))}}var oe={provide:r.APP_BOOTSTRAP_LISTENER,useFactory:ne,deps:[d.DOCUMENT,te,[new r.Optional,new r.Inject(t)],r.PLATFORM_ID,r.ApplicationRef,o],multi:!0},ie=function(){function t(){}return t.withConfig=function(e){return{ngModule:t,providers:[{provide:te,useValue:e}]}},t.decorators=[{type:r.NgModule,args:[{providers:[o,oe]}]}],t}();e.getNodeKeyForPreboot=b,e.PREBOOT_NONCE=t,e._window=n,e.EventReplayer=o,e.initAll=i,e.start=s,e.createOverlay=c,e.getAppRoot=u,e.handleEvents=a,e.createListenHandler=l,e.getSelection=g,e.createBuffer=p,e.initFunctionName=h,e.defaultOptions=y,e.getEventRecorderCode=v,e.getInlineDefinition=m,e.getInlineInvocation=w,e.validateOptions=_,e.assign=E,e.stringifyWithFunctions=S,e.PrebootModule=ie,e.ɵb=ne,e.ɵa=te,e.ɵc=oe,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=preboot.umd.min.js.map
